<html>
<head>
  <title>icebox</title>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Foundation for Sites</title>
  <link rel="stylesheet" href="./foundation.min.css">
  <style>
    body { 
      width: 97%;
      margin: auto;
      background-color: #f0f9FF; 
    }
    input{ width: 100%; }
    textarea{ width: 100%; }
  </style>
</head>
  <body>
    <script src="./lightwallet.min.js"></script>
    <script src="./index.js"></script>
    <script>

      var global_keystore;

      function newAddresses(password) {
        
        if (password == '') {
          password = prompt('Enter password to retrieve addresses', '');
          if(! password) { return false; }
        }

        global_keystore.keyFromPassword(password, function(err, pwDerivedKey) {
          if(! global_keystore.isDerivedKeyCorrect(pwDerivedKey)) {
            alert('Wrong password');
            return newAddresses('');
          }
          
          var numAddr = parseInt(document.getElementById('numAddr').value)
          global_keystore.generateNewAddress(pwDerivedKey, numAddr);

          showAddresses();
        });
      }

      function showAddresses() {
        if(typeof web3 === 'undefined'){
            web3 = new Web3();
        }
        var addresses = global_keystore.getAddresses();
        document.getElementById('addr').innerHTML = 'Retrieving addresses...'

        var addrString = ''
        document.getElementById('sendFrom').innerHTML = ''
        document.getElementById('addr').innerHTML = ''
        for (var i=0; i<addresses.length; ++i) {
          document.getElementById('addr').innerHTML += '<div>' + web3.toChecksumAddress(addresses[i]) + '</div>'
          if (i !== (addresses.length-1)) {
            addrString += addresses[i] + '_'; // i dont see any dashes on the page
          }
          else {
            addrString += addresses[i];
          }
        }
        
        // Add link to Workflow app
        var workflowURL = 'workflow://run-workflow?name=AddressQR&input=text&text='
        document.getElementById('workflowAddr').innerHTML = '<a href="' + workflowURL + addrString + '">Address QR Codes (Workflow App)</a>';

        // Add the 'sendFrom' modal
        document.getElementById('sendFrom').innerHTML = ''
        for (var i=0; i<addresses.length; ++i) {
          document.getElementById('sendFrom').innerHTML += '<option value="' + addresses[i] + '">' + addresses[i] + '</option>'
        }

      }

      function setSeed() {

        var password = prompt('Enter password to encrypt your seed for this session', '');
        if(! password) { return false; }

        var randomSeed = document.getElementById('seed').value;
        
        lightwallet.keystore.createVault({
          password: password,
          seedPhrase: randomSeed
        }, function(err, ks) {
          window.global_keystore = ks;
          newAddresses(password);
          document.getElementById('seed').value = '';
        });
      }

      function newWallet() {
        var extraEntropy = document.getElementById('userEntropy').value;
        document.getElementById('userEntropy').value = '';
        var randomSeed = lightwallet.keystore.generateRandomSeed(extraEntropy);

        var infoString = 'Your new wallet seed is: "' + randomSeed + 
          '". Please write it down on paper, you will need it to access your wallet. Do not let anyone see this seed or they can take your Ether. Please chooses a password to encrypt your wallet for this session.'

        var password = prompt(infoString, '');
        if(! password) { return false; }

        lightwallet.keystore.createVault({
          password: password,
          seedPhrase: randomSeed
        }, function(err, ks) {
          window.global_keystore = ks;
          newAddresses(password);
        });
      }

      function showSeed() {
        var password = prompt('Enter your password to show your seed.', '');
        if(! password) { return false; }

        global_keystore.keyFromPassword(password, function(err, pwDerivedKey) {
          if(! global_keystore.isDerivedKeyCorrect(pwDerivedKey)) {
            alert('Wrong password');
            return showSeed();
          }

          var seed = global_keystore.getSeed(pwDerivedKey);
          alert('Your seed is:\n\n"' + seed + '"\n\n. Please write it down.');
        })
      }

      function sendEth() {
        var password = prompt('Enter password to create and sign transaction', '');
        if(! password) { return false; }
        if(typeof web3 === 'undefined'){
            web3 = new Web3();
        }

        var fromAddr = document.getElementById('sendFrom').value
        var toAddr = document.getElementById('sendTo').value
        if(! web3.isAddress(toAddr)) { 
          alert("'To' address improperly formatted");
          return false; 
        }

        var valueEth = document.getElementById('sendValueAmount').value
        var value = parseFloat(valueEth)*1.0e18
        var nonce = parseInt(document.getElementById('nonce').value)
        var gasPrice = parseInt(document.getElementById('gasPrice').value)
        var gasLimit = parseInt(document.getElementById('gasLimit').value)
        var rawUnsignedTx = lightwallet.txutils.valueTx({to: toAddr, value: value, gasPrice: gasPrice, gasLimit: gasLimit, nonce: nonce})

        global_keystore.keyFromPassword(password, function(err, pwDerivedKey) {
          if(! global_keystore.isDerivedKeyCorrect(pwDerivedKey)) {
            alert('Wrong password');
            return sendEth();
          }

          var hex = lightwallet.signing.signTx(global_keystore, pwDerivedKey, rawUnsignedTx, fromAddr)
          document.getElementById('rawSignedTx').value = hex

          // Add link to Workflow app
          var workflowURL = 'workflow://run-workflow?name=TransactionQR&input=text&text='
          document.getElementById('workflowTx').innerHTML = '<a href="' + workflowURL + hex + '">Transaction QR Code (Workflow App)</a>';
          drawQR({hex: hex})
        })
      }

      buildQrString = (args)=>{
        args['apiKey'] = args['apiKey'] || "RCS8D6GHK9345T7ZVZJ6P491X9X6IMZ2AH"
        args['hex'] = args['hex'] || document.getElementById('rawSignedTx').value;
        var etherscanString = "https://api.etherscan.io/api?module=proxy&action=eth_sendRawTransaction&hex="+ args['hex'] +"&apikey="+args['apiKey'];
        var svg_string = Qr.imageSync(etherscanString, { type: 'svg' });
        return svg_string
      }

      drawQR = (args)=>{
        var svg_string = buildQrString(args);
        var canvas = document.getElementById('canvas');
        var length = (window.innerWidth > 0) ? window.innerWidth : screen.width;
        // canvas.style.width = length;
        // canvas.style.height = length;
        var ctx = canvas.getContext('2d');
        ctx.canvas.height = length;
        ctx.canvas.width = length;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        var data = svg_string
        var DOMURL = window.URL || window.webkitURL || window;
        var img = new Image();
        var svg = new Blob([data], {type: 'image/svg+xml'});
        var url = DOMURL.createObjectURL(svg);
        img.onload = function() {
          ctx.drawImage(img, 0, 0);
          DOMURL.revokeObjectURL(url);
        }
        img.src = url;
      }

      function saveWallet() {
        var serialized = global_keystore.serialize();
        document.getElementById('savedWallet').value = serialized;
      }

      function loadWallet() {
        var serialized = document.getElementById('loadedWallet').value;
        global_keystore = lightwallet.keystore.deserialize(serialized);
        showAddresses();
        alert('Wallet Loaded.');
      }

    </script>
    <div class="grid-container">

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <h1>Icebox</h1>
        </div>
      </div>
      
        <div class="grid-x grid-padding-x">
          <div class="large-12 cell">
            <label>New Wallet</label>
            <input type="text" id="userEntropy" placeholder="Type random text to generate entropy" size="80"></input>
            <button class="button" onclick="newWallet()">Create New Wallet</button>
          </div>
        </div>

      <hr />
      
        <div class="grid-x grid-padding-x">
          <div class="large-12 cell">
            <label>Restore Wallet From Seed</label>
            <input type="text" id="seed" value="" size="80"></input>
            <button class="button" onclick="setSeed()">Restore wallet from Seed</button>
          </div>
        </div>

      <hr />
      
        <div class="grid-x grid-padding-x">
          <div class="large-12 cell">
            <label>Show (x) More Addresses</label>
            <input type="text" id="numAddr" size="5" value="3"></input>
            <button class="button" onclick="newAddresses('')">Show</button>
            <label class="subheader">HD addresses derived from BIP32 12-word seed</label>
            <div id="addr"></div>
            <div id="workflowAddr"></div>
          </div>
        </div>

      <hr />

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <h5>Send Ether</h5>
        </div>
      </div>

        <div class="grid-x grid-padding-x">
          <div class="large-12 cell">
            <label>From</label>
            <select id="sendFrom"></select>
          </div>
          <div class="large-12 cell">
            <label>To</label>
            <input type="text" size="40" id="sendTo"></input>
          </div>
          <div class="large-12 cell">
            <label>Ether</label>
            <input type="text" id="sendValueAmount">
          </div>
          <div class="large-12 cell">
            <label>Nonce</label>
            <input type="text" id="nonce">
          </div>
          <div class="large-12 cell">
            <label>Gas Price (Wei)</label>
            <input type="text" id="gasPrice" value=20000000000>
          </div>
          <div class="large-12 cell">
            <label>Gas Limit</label>
            <input type="text" id="gasLimit" value=21000>
          </div>
          <div class="large-12 cell">
            <button class="button" onclick="sendEth()">Create Transaction</button>
          </div>
          
        </div>

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <label>Scan to send through Etherscan API</label>
          <canvas id="canvas" style="width:300px; height:300px"></canvas>
          <label>Signed Transaction Data</label>
          <div><textarea id='rawSignedTx' rows=6 cols=40></textarea></div>
          <div id='workflowTx'></div>
        </div>
      </div>

      <hr />

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <label>Show Seed</label>
          <button class="button" onclick="showSeed()">Show Seed</button>
        </div>
      </div>

      <hr />

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <label>Save Encrypted Wallet (JSON)</label>
          <textarea id='savedWallet' rows=6 cols=40></textarea>
          <button class="button" onclick="saveWallet()">Save Wallet</button>
        </div>
      </div>

      <hr />

      <div class="grid-x grid-padding-x">
        <div class="large-12 cell">
          <label>Load Encrypted Wallet (JSON)</label>
          <textarea id='loadedWallet' rows=6 cols=40></textarea>
          <button class="button" onclick="loadWallet()">Load Wallet</button>
        </div>
      </div>
      
    </div>
  </body>
</html>
